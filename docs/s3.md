S3 Buckets to optionally create and reference in your deployment. This need to be added under infrastructure section with buckets and support attributes. If no bucket is needed, just donâ€™t have to add buckets section with the infrastructure.

## Buckets
Here is the sample format to add buckets to the application.

```bash
infrastructure:
  buckets:
    managed:
      - prefix: <BUCKET_NAME>
    existing:
      - project_name: <RELEASE_NAME_IN_NAMESPACE>
        project_group: <NAMESPACE>
        bucket_prefix: <BUCKET_NAME>
      - full_name: <EXTERNAL_BUCKET_NAME>
        reference: <FRIENDLY_NAME>
        read_only: <Boolean>
```

Example

```bash
infrastructure:
  buckets:
    managed:
      - prefix: demo-123
    existing:
      - project_group: demo
        project_name: demo-python-flask-variant-api
        bucket_prefix: demo-123
      - full_name: usx-store-123
        reference: foo
        read_only: false
```


### Supported attributes

| Property | Type   | Required | Default | Description                                                                                      |
|----------|--------|----------|---------|--------------------------------------------------------------------------------------------------|
| managed  | string | false    | N/A     | This need to be added to create new bucket. Add as an array to create multiple buckets.          |
| existing  | string | false    | N/A     | This need to be added to refer any existing  buckets. Add as an array to refer multiple buckets. |

### managed

Adding prefix under this section will create a new bucket in the AWS and will provide required permissions to the app to access the bucket. If multiple buckets need to be created then it can be added as array to the managed object.

Adding bucket with below format will create an env variable and can be referenced as BUCKET__<PREFIX>__name in the code and the bucket name will be something like demo-123.

| Property | Type   | Required | Default | Description                                    |
|----------|--------|----------|---------|------------------------------------------------|
| prefix   | string | true     | N/A     | Name of the bucket (Example:  demo-flask-api ) |

Example

```bash
infrastructure:
  buckets:
    managed:
      - prefix: demo-123
```

### existing

Below mentioned attributes in the table are supported for existing object. If multiple buckets are needed to the app, then it can be added as an array to the existing object.

### Use case 1:
To refer buckets created in same AWS acoount and using actions-v3 then bucket_prefix, project_name, project_group are required and no need to add other full_name and reference parameters.

Also action will create below environment variables to refer bucket in the application code.

### Exposed environment variables

Below are the exposed env variables and can be referenced  in the code with below names.

| Env variable                  | Description          |
|-------------------------------|----------------------|
| BUCKET__<BUCKET_PREFIX>__name | To refer bucket name |
| BUCKET__<BUCKET_PREFIX>__arn  | Bucket arn           |

Example:

```bash
infrastructure:
  buckets:
    existing:
      - project_group: demo
        project_name: demo-python-flask-variant-api
        bucket_prefix: demo-123
```

### Use case 2:

To have backward compatibility for existing systems and bucket is created outside of octopus-v3, then full_name & reference are required and don't need to set bucket prefix and project group parameters.

Also this will allow to create below environment variables to refer bucket in the application code.

### Exposed environment variables

Below are the exposed env variables and can be referenced in the code with below names.

| Env variable                  | Description          |
|-------------------------------|----------------------|
| BUCKET__<REFERENCE>__name | To refer bucket name |
| BUCKET__<REFERENCE>__arn  | Bucket arn           |


Example

```bash
infrastructure:
  buckets:
    existing:
      - full_name: usx-store-123
        reference: foo
        read_only: false
```

### Supported arguments

| Property      | Type   | Required | Description                                                                                                                                                 |
|---------------|--------|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| full_name     | string | optional | This will be external bucket to refer which is not created using actions-v3. When full name is provided, reference attribute will become mandatory (Example: usx-store-123)             |
| reference     | string | optional | It is a friendly name to create environment variables for external bucket. (Example: foo)                                                                                       |
| read_only     | bool   | optional | Defaut is set to true. To set iam policies on the bucket.                                                                                                                                     |
| bucket_prefix | string | optional | Bucket to refer from the app which is created part of any project using actions-v3 (Example:demo-123). When bucket_prefix is added project_group, project_name will become mandatory. This will be used to lookup in those project groups |
| project_group | string | optional | namespace (Example: demo)                                                                                                                                   |
| project_name  | string | optional | Release name in namespace (Example:  demo-python-flask-variant-api)                                                                                         |

